var db = require('database');
var fs = require('fs');
db.start();

/*
 * Search Engine
 */
function Search() {
	function search(document, query, section, cb){
		if ( !query.trim() ) return cb("please insert query to search for");

		var query 	= query,
			section = section,
			sql 	= '',
			route 	= '';

		switch (section) {
			case 'patients':
				sql = "SELECT id, name, code FROM patients WHERE active = '1' AND name LIKE '%"+ query +"%' OR code LIKE '%"+ query +"%'";
				route = "patient-profile";
			break;
			case 'beds':
				sql = "";
				route = "patient-profile";
			break;
			case 'groups':
				sql = "SELECT id, name, created_at FROM groups WHERE name LIKE '%"+ query +"%'";
				route = "group-profile";
			break;
			case 'diets':
				sql = "SELECT id, name, created_at FROM diets WHERE name LIKE '%"+ query +"%'";
				route = "diet-profile";
			break;
			case 'booking':
				sql = "SELECT id, name, code FROM patients WHERE active = '0' AND name LIKE '%"+ query +"%' OR code LIKE '%"+ query +"%'";
				route = "booking-profile";
			break;
			case 'employees':
				sql = "";
			break;
			case 'machines':
				sql = "";
			break;
			case 'categories':
				sql = "";
			break;
			case 'sessions':
				sql = "";
			break;
		}

		db.DB().query(sql, function(err, rows, fields){
			// if there is an error in DB then display it
			if (err) throw err;

			// if rows is empty (no data found) then display message
			if (!rows || !rows.length) {
				return cb("there is NO Results for " + query);
			};

			// Load page Search
			var hema = fs.readFileSync("assets/views/pages/search.html", 'utf-8');
			document.getElementById('inside-page').innerHTML = hema;
			document.getElementById('search-page').getElementsByTagName('h1')[0].getElementsByTagName('span')[0].innerHTML = "Search For \"" + query + "\"";

			var thead = document.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0],
				tfoot = document.getElementsByTagName('tfoot')[0].getElementsByTagName('tr')[0],
				tbody = document.getElementsByTagName('tbody')[0];

			if ( rows.length ) {
				for (i = 1; i <= fields.length - 1; i++) {
					thead.innerHTML += '<th>'+ fields[i].name +'</th>';
					tfoot.innerHTML += '<th>'+ fields[i].name +'</th>';
				};
				thead.innerHTML += '<th class="action">action</th>';
				tfoot.innerHTML += '<th class="action">action</th>';

				for (i = 0; i <= rows.length - 1; i++) {
					var content = '';
					for (y = 1; y <= fields.length - 1; y++) {
						content += "<td>"+ rows[i][fields[y].name] +"</td>";
					};
					content += "<td class='action'><a class='btn' href='"+ route +"' id='"+ rows[i].id +"'><i class='icon-edit'></i></a></td>";
					tbody.innerHTML += "<tr>"+ content +"</tr>";
				};
			};
			cb("");
		});
	}
	this.search = search;
}
module.exports = new Search;

